<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HF Datasets by Category over Time</title>
    <style>
      html, body { height: 100%; margin: 0; }
      #chart { height: 100vh; width: 100vw; }
      #logo {
        position: fixed;
        right: 12px;
        bottom: 12px;
        width: 120px;
        max-width: 20vw;
        opacity: 0.9;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div id="chart"></div>
    <img id="logo" src="https://aiworld.eu/logo-transparent.svg" alt="AI World logo" />

    <!-- ECharts (CDN) -->
    <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
      const DATA_URL = "Datasets/hf_boss.csv";
      const dom = document.getElementById("chart");
      const chart = echarts.init(dom);

      function toMonthKey(dateString) {
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) return null;
        return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, "0")}`;
      }

      function extractCategories(categoryField) {
        if (!categoryField) return [];
        // Support simple strings or delimited lists
        return String(categoryField)
          .split(/[,;|]/)
          .map((cat) => cat.trim())
          .filter(Boolean);
      }

      async function loadAndRender() {
        chart.showLoading("default", { text: "Loading HF datasets..." });
        try {
          const response = await fetch(DATA_URL);
          if (!response.ok) throw new Error(`Failed to load CSV (${response.status})`);
          const text = await response.text();
          const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
          const data = parsed.data;

          const monthSet = new Set();
          const categoryTotals = new Map();
          const countsByCategory = new Map();

          for (const row of data) {
            const month = toMonthKey(row.created_at);
            if (!month) continue;
            const categories = extractCategories(row.category);
            if (!categories.length) continue;

            monthSet.add(month);
            for (const category of categories) {
              const monthCounts = countsByCategory.get(category) ?? new Map();
              monthCounts.set(month, (monthCounts.get(month) ?? 0) + 1);
              countsByCategory.set(category, monthCounts);
              categoryTotals.set(category, (categoryTotals.get(category) ?? 0) + 1);
            }
          }

          const months = Array.from(monthSet).sort();
          const topCategories = Array.from(categoryTotals.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8)
            .map(([category]) => category);

          // Spectral-inspired palette (extendable)
          const colorPalette = [
            "#80FFA5", // green
            "#00DDFF", // cyan
            "#37A2FF", // blue
            "#FF0087", // magenta
            "#FFBF00", // yellow
            "#9BFF80", // lime
            "#9D4DFF", // violet
            "#FF7A00"  // orange
          ];
          const series = topCategories.map((category, index) => {
            const color = colorPalette[index % colorPalette.length];
            return {
              name: category,
              type: "line",
              stack: "datasets",
              smooth: true,
              showSymbol: false,
              lineStyle: { width: 1, color },
              areaStyle: {
                opacity: 0.7,
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                  { offset: 0, color },
                  { offset: 1, color: echarts.color.lift(color, 0.6) }
                ])
              },
              emphasis: { focus: "series" },
              data: months.map((month) => countsByCategory.get(category)?.get(month) ?? 0)
            };
          });

          chart.setOption({
            color: colorPalette,
            title: {
              text: "HF datasets by task category over time",
              left: "center"
            },
            tooltip: {
              trigger: "axis",
              valueFormatter: (value) => `${value} datasets`
            },
            legend: {
              data: topCategories,
              bottom: 10
            },
            toolbox: { feature: { saveAsImage: {} } },
            grid: { left: "4%", right: "2%", bottom: "14%", containLabel: true },
            xAxis: [
              {
                type: "category",
                boundaryGap: false,
                data: months,
                axisLabel: { rotate: 45 }
              }
            ],
            yAxis: [{ type: "value", name: "Datasets per month" }],
            series
          });
        } catch (error) {
          chart.clear();
          chart.setOption({
            title: { text: "Failed to load data", left: "center" },
            graphic: {
              type: "text",
              left: "center",
              top: "middle",
              style: {
                text: error.message,
                fill: "#c0392b",
                fontSize: 16
              }
            }
          });
          console.error(error);
        } finally {
          chart.hideLoading();
        }
      }

      loadAndRender();

      // Responsive
      window.addEventListener("resize", () => chart.resize());
      new ResizeObserver(() => chart.resize()).observe(dom);
    </script>
  </body>
</html>
